# Amazon Linux 2023 기준
# AMI마다 ModSecurity 설치 시 설정 파일 경로 다름 -> 실무에서는 대부분 AMI 하나에 맞춰서 플레이북 만듦

---
# 필수 패키지 설치 전 curl 안정화
- name: Gather installed packages
  ansible.builtin.package_facts:

# Amazon Linux 2023에 curl-minimal이 이미 설치되어 있어 제거 후 curl 설치
- name: Remove curl-minimal if exists
  ansible.builtin.yum:
    name: curl-minimal
    state: absent
  when: "'curl-minimal' in ansible_facts.packages"
  ignore_errors: yes

- name: Install curl if not installed
  ansible.builtin.yum:
    name: curl
    state: present
  when: "'curl' not in ansible_facts.packages"

# 필수 패키지 설치
- name: Install required packages
  dnf:
    name:
      - nginx
      - mod_security
      - mod_security_crs
    state: present

# /etc/modsecurity 디렉토리 생성
- name: Ensure /etc/modsecurity exists
  file:
    path: /etc/modsecurity
    state: directory
    owner: root
    group: root
    mode: '0755'

# ModSecurity 설정 파일 템플릿 배포
- name: Deploy ModSecurity config via template
  template:
    src: modsecurity.conf.j2
    dest: /etc/modsecurity/modsecurity.conf
    owner: root
    group: root
    mode: '0644'

# Nginx 메인 conf 수정: load_module 추가 (0208 04:02)
- name: Ensure Nginx loads ModSecurity module
  lineinfile:
    path: /etc/nginx/nginx.conf
    insertafter: BOF  # 파일 맨 위
    line: 'load_module modules/ngx_http_modsecurity_module.so;'
    state: present

# Nginx에 ModSecurity 연동
- name: Enable ModSecurity in Nginx
  copy:
    dest: /etc/nginx/conf.d/modsecurity.conf
    content: |
      # load_module modules/ngx_http_modsecurity_module.so;
      modsecurity on;
      modsecurity_rules_file /etc/modsecurity/modsecurity.conf;

# 기본 Nginx 서버 설정
- name: Configure Nginx default site
  copy:
    dest: /etc/nginx/conf.d/default.conf
    content: |
      server {
          listen 80;
          server_name _;

          location / {
              return 200 "Nginx + ModSecurity WAF OK\n";
          }
      }

# Nginx 시작
- name: Start and enable Nginx
  systemd:
    name: nginx
    state: started
    enabled: yes
