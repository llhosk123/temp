# K3s 클러스터에 애플리케이션(API + DB) 배포 자동화 플레이북
# 1. 앱 관련 Kubernetes YAML 파일(k3s/*.yml = K3s 매니페스트 파일)을 EC2 서버로 복사
# 2. kubectl 명령어로 클러스터에 적용하여 파드와 서비스 생성

---
- name: Deploy App to K3s
  hosts: aws
  become: yes
  tasks:
    # kubectl apply를 원격 서버에서 실행하려면 K3s 매니페스트 파일이 서버에 있어야 함
    - name: Copy K3s manifests to remote
      ansible.builtin.copy:
        src: ../k3s/
        dest: /home/ec2-user/my-project/k3s/ # 원격 EC2 서버 경로, 없으면 자동 생성
        mode: '0755'

    # Deployment, Service 등 정의한 리소스가 생성됨
    # KUBECONFIG 환경 변수를 지정하여, kubectl이 올바른 K3s 클러스터에 연결되도록 함
    - name: Apply Kubernetes manifests
      ansible.builtin.shell: |
        kubectl apply -f /home/ec2-user/my-project/k3s/
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml # K3s kubeconfig 경로
